{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"django-rls","text":"<p>Django extension for PostgreSQL Row-Level Security (RLS)</p> <p>django-rls provides a seamless way to implement Row-Level Security (RLS) in your Django applications using PostgreSQL's native RLS features. It integrates with Django's middleware system and supports both traditional Django views and Strawberry GraphQL.</p>"},{"location":"#features","title":"Features","text":"<ul> <li>\ud83d\udd12 PostgreSQL RLS Integration: Leverage PostgreSQL's native Row-Level Security policies</li> <li>\ud83c\udfaf Automatic Field Management: Auto-fill RLS fields on model creation</li> <li>\ud83d\udd27 Flexible Configuration: Customizable resolvers for different contexts</li> <li>\ud83d\ude80 Strawberry GraphQL Support: Built-in resolvers for Strawberry GraphQL</li> <li>\ud83d\udee1\ufe0f Bypass Controls: Configurable bypass checks for superusers and special cases</li> <li>\ud83d\udce6 Migration Support: Safe migration handling with dedicated database users</li> </ul>"},{"location":"#quick-example","title":"Quick Example","text":"<pre><code># settings.py\nfrom django_rls.settings_type import DjangoRLSSettings\nfrom django_rls.resolvers import default_request_user_resolver, default_rls_bypass_check\n\nDJANGO_RLS = DjangoRLSSettings(\n    RLS_FIELDS=[\"tenant_id\", \"user_id\"],\n    TENANT_APPS=[\"myapp\"],\n    REQUEST_RESOLVER=default_request_user_resolver,\n    BYPASS_CHECK_RESOLVER=default_rls_bypass_check,\n    AUTO_SET_FIELDS=True,\n)\n</code></pre> <pre><code># middleware.py\nMIDDLEWARE = [\n    # ... other middleware\n    'django_rls.middleware.RLSMiddleware',\n    # ... rest of middleware\n]\n</code></pre>"},{"location":"#installation","title":"Installation","text":"<pre><code>pip install django-rls\n</code></pre>"},{"location":"#documentation","title":"Documentation","text":"<ul> <li>Installation Guide</li> <li>Quick Start</li> <li>Configuration</li> <li>Usage Examples</li> </ul>"},{"location":"#requirements","title":"Requirements","text":"<ul> <li>Django &gt;= 4.2, &lt; 5.4</li> <li>PostgreSQL (RLS is PostgreSQL-only)</li> <li>Python &gt;= 3.10, &lt; 3.14</li> </ul>"},{"location":"#license","title":"License","text":"<p>MIT License - see LICENSE file for details.</p>"},{"location":"#links","title":"Links","text":"<ul> <li>GitHub Repository</li> <li>Issue Tracker</li> </ul>"},{"location":"advanced/bypass-checks/","title":"Bypass Checks","text":"<p>Bypass checks determine when RLS should be completely bypassed, allowing access to all data regardless of RLS policies.</p> <p>For API documentation on bypass check functions, see the API Reference (search for <code>bypass</code>).</p>"},{"location":"advanced/bypass-checks/#default-behavior","title":"Default Behavior","text":"<p>The default bypass check allows superusers to bypass RLS:</p> <pre><code>from django_rls.resolvers import default_rls_bypass_check\n\nDJANGO_RLS = DjangoRLSSettings(\n    BYPASS_CHECK_RESOLVER=default_rls_bypass_check,\n)\n</code></pre>"},{"location":"advanced/bypass-checks/#custom-bypass-checks","title":"Custom Bypass Checks","text":""},{"location":"advanced/bypass-checks/#role-based-bypass","title":"Role-Based Bypass","text":"<pre><code>from typing import Any\n\ndef role_based_bypass(request: Any) -&gt; bool:\n    \"\"\"\n    Bypass RLS for users with specific roles.\n    \"\"\"\n    user = getattr(request, 'user', None)\n    if not user or not getattr(user, 'is_authenticated', False):\n        return False\n\n    # Bypass for superusers\n    if getattr(user, 'is_superuser', False):\n        return True\n\n    # Bypass for admin role\n    if hasattr(user, 'role') and user.role == 'admin':\n        return True\n\n    # Bypass for staff\n    if getattr(user, 'is_staff', False):\n        return True\n\n    return False\n\nDJANGO_RLS = DjangoRLSSettings(\n    BYPASS_CHECK_RESOLVER=role_based_bypass,\n)\n</code></pre>"},{"location":"advanced/bypass-checks/#ip-based-bypass","title":"IP-Based Bypass","text":"<pre><code>from typing import Any\n\ndef ip_based_bypass(request: Any) -&gt; bool:\n    \"\"\"\n    Bypass RLS for requests from specific IP addresses.\n    \"\"\"\n    ip = request.META.get('REMOTE_ADDR')\n    trusted_ips = ['127.0.0.1', '192.168.1.100', '10.0.0.0/8']\n\n    for trusted_ip in trusted_ips:\n        if ip == trusted_ip or ip.startswith(trusted_ip):\n            return True\n\n    return False\n\nDJANGO_RLS = DjangoRLSSettings(\n    BYPASS_CHECK_RESOLVER=ip_based_bypass,\n)\n</code></pre>"},{"location":"advanced/bypass-checks/#path-based-bypass","title":"Path-Based Bypass","text":"<pre><code>from typing import Any\n\ndef path_based_bypass(request: Any) -&gt; bool:\n    \"\"\"\n    Bypass RLS for specific URL paths (e.g., admin interface).\n    \"\"\"\n    bypass_paths = ['/admin/', '/api/admin/', '/internal/']\n\n    for path in bypass_paths:\n        if request.path.startswith(path):\n            return True\n\n    return False\n\nDJANGO_RLS = DjangoRLSSettings(\n    BYPASS_CHECK_RESOLVER=path_based_bypass,\n)\n</code></pre>"},{"location":"advanced/bypass-checks/#combined-bypass","title":"Combined Bypass","text":"<pre><code>from typing import Any\n\ndef combined_bypass(request: Any) -&gt; bool:\n    \"\"\"\n    Combine multiple bypass conditions.\n    \"\"\"\n    user = getattr(request, 'user', None)\n\n    # Superuser bypass\n    if user and getattr(user, 'is_superuser', False):\n        return True\n\n    # IP bypass\n    ip = request.META.get('REMOTE_ADDR')\n    if ip in ['127.0.0.1', '192.168.1.100']:\n        return True\n\n    # Path bypass\n    if request.path.startswith('/admin/'):\n        return True\n\n    # Header bypass (for internal services)\n    if request.META.get('HTTP_X_INTERNAL_SERVICE') == 'true':\n        return True\n\n    return False\n\nDJANGO_RLS = DjangoRLSSettings(\n    BYPASS_CHECK_RESOLVER=combined_bypass,\n)\n</code></pre>"},{"location":"advanced/bypass-checks/#what-happens-when-bypassed","title":"What Happens When Bypassed?","text":"<p>When <code>BYPASS_CHECK_RESOLVER</code> returns <code>True</code>, all RLS fields are set to <code>RlsWildcard.ALL</code>:</p> <pre><code># Normal request\n{\n    \"tenant_id\": 123,\n    \"user_id\": 456,\n}\n\n# Bypassed request\n{\n    \"tenant_id\": RlsWildcard.ALL,\n    \"user_id\": RlsWildcard.ALL,\n}\n</code></pre> <p>PostgreSQL RLS policies should handle this wildcard appropriately, or you can create policies that allow access when the value is the wildcard.</p>"},{"location":"advanced/bypass-checks/#security-considerations","title":"Security Considerations","text":"<p>\u26a0\ufe0f Warning: Bypass checks should be used carefully. Only bypass RLS when absolutely necessary and ensure proper authentication/authorization is in place.</p> <p>Best practices: - Always verify user authentication - Use specific conditions (don't bypass too broadly) - Log bypass events for auditing - Review bypass logic regularly</p>"},{"location":"advanced/bypass-checks/#testing-bypass-checks","title":"Testing Bypass Checks","text":"<pre><code>from django.test import RequestFactory\nfrom myapp.bypass import role_based_bypass\n\ndef test_bypass_check():\n    factory = RequestFactory()\n    request = factory.get('/')\n\n    # Test without user\n    assert role_based_bypass(request) == False\n\n    # Test with superuser\n    from django.contrib.auth import get_user_model\n    User = get_user_model()\n    user = User.objects.create_superuser('admin', 'admin@example.com', 'password')\n    request.user = user\n\n    assert role_based_bypass(request) == True\n</code></pre>"},{"location":"advanced/bypass-checks/#next-steps","title":"Next Steps","text":"<ul> <li>Custom Resolvers - Custom resolver patterns</li> <li>Configuration - Bypass check configuration</li> </ul>"},{"location":"advanced/custom-resolvers/","title":"Custom Resolvers","text":"<p>Create custom resolvers to extract RLS context from your specific request structure.</p> <p>For API documentation on resolver functions, see the API Reference (search for <code>resolvers</code>).</p>"},{"location":"advanced/custom-resolvers/#request-based-resolver","title":"Request-Based Resolver","text":"<p>For Django views and REST APIs:</p> <pre><code>from typing import Any, Dict\nfrom django_rls.constants import RLSValue, RlsWildcard\n\ndef custom_request_resolver(request: Any) -&gt; Dict[str, RLSValue]:\n    \"\"\"\n    Extract RLS values from custom request structure.\n    \"\"\"\n    # Example: Extract from custom headers\n    tenant_id = request.META.get('HTTP_X_TENANT_ID')\n    user_id = request.META.get('HTTP_X_USER_ID')\n\n    context = {}\n\n    if tenant_id:\n        context['tenant_id'] = int(tenant_id)\n    else:\n        context['tenant_id'] = RlsWildcard.NONE\n\n    if user_id:\n        context['user_id'] = int(user_id)\n    else:\n        context['user_id'] = RlsWildcard.NONE\n\n    return context\n\nDJANGO_RLS = DjangoRLSSettings(\n    REQUEST_RESOLVER=custom_request_resolver,\n)\n</code></pre>"},{"location":"advanced/custom-resolvers/#jwt-token-resolver","title":"JWT Token Resolver","text":"<p>Extract RLS values from JWT tokens:</p> <pre><code>import jwt\nfrom typing import Any, Dict\nfrom django_rls.constants import RLSValue\n\ndef jwt_token_resolver(request: Any) -&gt; Dict[str, RLSValue]:\n    \"\"\"\n    Extract RLS values from JWT token in Authorization header.\n    \"\"\"\n    auth_header = request.META.get('HTTP_AUTHORIZATION', '')\n    if not auth_header.startswith('Bearer '):\n        return {}\n\n    token = auth_header.split(' ')[1]\n    try:\n        payload = jwt.decode(token, 'your-secret-key', algorithms=['HS256'])\n        return {\n            'tenant_id': payload.get('tenant_id'),\n            'user_id': payload.get('user_id'),\n        }\n    except jwt.InvalidTokenError:\n        return {}\n\nDJANGO_RLS = DjangoRLSSettings(\n    REQUEST_RESOLVER=jwt_token_resolver,\n)\n</code></pre>"},{"location":"advanced/custom-resolvers/#multi-tenant-with-subdomain","title":"Multi-Tenant with Subdomain","text":"<p>Extract tenant from subdomain:</p> <pre><code>from typing import Any, Dict\nfrom django_rls.constants import RLSValue\n\ndef subdomain_tenant_resolver(request: Any) -&gt; Dict[str, RLSValue]:\n    \"\"\"\n    Extract tenant from subdomain.\n    \"\"\"\n    host = request.get_host()\n    subdomain = host.split('.')[0]\n\n    # Look up tenant by subdomain\n    from myapp.models import Tenant\n    try:\n        tenant = Tenant.objects.get(subdomain=subdomain)\n        return {\n            'tenant_id': tenant.id,\n            'user_id': getattr(request.user, 'id', None) if request.user.is_authenticated else None,\n        }\n    except Tenant.DoesNotExist:\n        return {}\n\nDJANGO_RLS = DjangoRLSSettings(\n    REQUEST_RESOLVER=subdomain_tenant_resolver,\n)\n</code></pre>"},{"location":"advanced/custom-resolvers/#complex-nested-resolver","title":"Complex Nested Resolver","text":"<p>Handle complex user relationships:</p> <pre><code>from typing import Any, Dict\nfrom django_rls.constants import RLSValue, RlsWildcard\n\ndef complex_user_resolver(request: Any) -&gt; Dict[str, RLSValue]:\n    \"\"\"\n    Extract RLS values from complex user relationships.\n    \"\"\"\n    user = getattr(request, 'user', None)\n    if not user or not getattr(user, 'is_authenticated', False):\n        return {}\n\n    context = {}\n\n    # Primary tenant\n    if hasattr(user, 'primary_tenant'):\n        context['tenant_id'] = user.primary_tenant.id\n    elif hasattr(user, 'tenant'):\n        context['tenant_id'] = user.tenant.id\n    else:\n        context['tenant_id'] = RlsWildcard.NONE\n\n    # User ID\n    context['user_id'] = user.id\n\n    # Organization (if exists)\n    if hasattr(user, 'organization'):\n        context['organization_id'] = user.organization.id\n\n    # Department (if exists)\n    if hasattr(user, 'department'):\n        context['department_id'] = user.department.id\n\n    return context\n\nDJANGO_RLS = DjangoRLSSettings(\n    RLS_FIELDS=['tenant_id', 'user_id', 'organization_id', 'department_id'],\n    REQUEST_RESOLVER=complex_user_resolver,\n)\n</code></pre>"},{"location":"advanced/custom-resolvers/#testing-resolvers","title":"Testing Resolvers","text":"<p>Test your custom resolvers:</p> <pre><code>from django.test import RequestFactory\nfrom django.contrib.auth.models import AnonymousUser\nfrom myapp.resolvers import custom_request_resolver\n\ndef test_custom_resolver():\n    factory = RequestFactory()\n    request = factory.get('/')\n    request.user = AnonymousUser()\n\n    result = custom_request_resolver(request)\n    assert result == {}\n\n    # Test with authenticated user\n    from django.contrib.auth import get_user_model\n    User = get_user_model()\n    user = User.objects.create_user('test', 'test@example.com')\n    request.user = user\n\n    result = custom_request_resolver(request)\n    assert 'user_id' in result\n</code></pre>"},{"location":"advanced/custom-resolvers/#next-steps","title":"Next Steps","text":"<ul> <li>Bypass Checks - Custom bypass logic</li> <li>Resolvers - Built-in resolvers</li> </ul>"},{"location":"api/","title":"Table of Contents","text":"<ul> <li>django_rls</li> <li>django_rls.resolvers</li> <li>default_request_user_resolver</li> <li>default_rls_bypass_check</li> <li>strawberry_context_user_resolver</li> <li>strawberry_rls_bypass_check</li> <li>django_rls.utils</li> <li>get_field_sql_type</li> <li>build_rls_using_clause</li> <li>django_rls.settings</li> <li>django_rls.constants</li> <li>django_rls.apps</li> <li>django_rls.middleware</li> <li>RLSMiddleware</li> <li>django_rls.exceptions</li> <li>django_rls.admin</li> <li>django_rls.settings_type</li> <li>DjangoRLSSettings<ul> <li>RLS_FIELDS</li> <li>TENANT_APPS</li> <li>REQUEST_RESOLVER</li> <li>BYPASS_CHECK_RESOLVER</li> <li>AUTO_SET_FIELDS</li> <li>SKIP_MODELS</li> <li>SESSION_NAMESPACE_PREFIX</li> <li>USE_DB_MIGRATION_USER</li> <li>MIGRATION_USER</li> <li>MIGRATION_PASSWORD</li> </ul> </li> <li>django_rls.migration_hook</li> <li>django_rls.migrations</li> <li>RunDynamicSQL</li> <li>django_rls.management.commands.add_rls</li> <li>django_rls.management.commands.makemigrations</li> <li>django_rls.management.commands</li> <li>django_rls.management</li> </ul>"},{"location":"api/#django_rls","title":"django_rls","text":""},{"location":"api/#django_rlsresolvers","title":"django_rls.resolvers","text":""},{"location":"api/#default_request_user_resolver","title":"default_request_user_resolver","text":"<pre><code>def default_request_user_resolver(request: Any) -&gt; Dict[str, RLSValue]\n</code></pre> <p>Default RLS resolver for standard Django requests in REQUEST_RESOLVER.</p> <p>Dynamically builds a dict based on the fields in RLS_FIELDS. Extracts the value directly from request.user.{field} - fields must map exactly.</p> <p>If user is not authenticated or a field doesn't exist, returns RlsWildcard.NONE for that field.</p> <p></p>"},{"location":"api/#default_rls_bypass_check","title":"default_rls_bypass_check","text":"<pre><code>def default_rls_bypass_check(request: Any) -&gt; bool\n</code></pre> <p>Returns True if the current request's user is a superuser. Default for BYPASS_CHECK_RESOLVER.</p> <p></p>"},{"location":"api/#strawberry_context_user_resolver","title":"strawberry_context_user_resolver","text":"<pre><code>def strawberry_context_user_resolver(info: Any) -&gt; Dict[str, RLSValue]\n</code></pre> <p>Strawberry GraphQL version of the default resolver.</p> <p>Reads info.context.user and resolves all RLS_FIELDS dynamically. Fields must map exactly to user attributes - no fallback logic.</p> <p></p>"},{"location":"api/#strawberry_rls_bypass_check","title":"strawberry_rls_bypass_check","text":"<pre><code>def strawberry_rls_bypass_check(info: Any) -&gt; bool\n</code></pre> <p>Returns True if the info.context.user is a superuser. Intended for use as a BYPASS_CHECK_RESOLVER.</p> <p></p>"},{"location":"api/#django_rlsutils","title":"django_rls.utils","text":""},{"location":"api/#get_field_sql_type","title":"get_field_sql_type","text":"<pre><code>def get_field_sql_type(model: models.Model, field_name: str) -&gt; str\n</code></pre> <p>Maps Django field types to PostgreSQL SQL types for RLS policy generation.</p> <p>Arguments:</p> <ul> <li><code>model</code> - The Django model instance</li> <li><code>field_name</code> - Name of the field to get the SQL type for</li> </ul> <p>Returns:</p> <p>PostgreSQL SQL type string (e.g., 'int', 'uuid', 'text')</p> <p>Raises:</p> <ul> <li><code>FieldDoesNotExist</code> - If the field does not exist on the model</li> </ul> <p></p>"},{"location":"api/#build_rls_using_clause","title":"build_rls_using_clause","text":"<pre><code>def build_rls_using_clause(fields: List[str], field_types: Dict[str, str],\n                           session_prefix: str) -&gt; str\n</code></pre> <p>Constructs the RLS USING clause with wildcard and null handling for each field.</p> <p>Each field is wrapped in a CASE statement that handles: - NULL session variables (returns FALSE) - Empty strings (returns FALSE) - RlsWildcard.NONE (returns FALSE) - RlsWildcard.ALL (returns TRUE - bypasses RLS) - Normal values (compares field to session variable)</p> <p>Arguments:</p> <ul> <li><code>fields</code> - List of field names to include in the RLS policy</li> <li><code>field_types</code> - Dictionary mapping field names to their PostgreSQL SQL types</li> <li><code>session_prefix</code> - Prefix for session variables (typically \"rls\")</li> </ul> <p>Returns:</p> <p>SQL string containing the USING clause for the RLS policy</p> <p></p>"},{"location":"api/#django_rlssettings","title":"django_rls.settings","text":""},{"location":"api/#django_rlsconstants","title":"django_rls.constants","text":""},{"location":"api/#django_rlsapps","title":"django_rls.apps","text":""},{"location":"api/#django_rlsmiddleware","title":"django_rls.middleware","text":""},{"location":"api/#rlsmiddleware-objects","title":"RLSMiddleware Objects","text":"<pre><code>class RLSMiddleware(MiddlewareMixin)\n</code></pre> <p>Middleware that sets PostgreSQL session variables based on RLS context.</p> <ul> <li>If BYPASS_CHECK_RESOLVER returns True, sets all session vars to RlsWildcard.ALL.</li> <li>Otherwise uses VALUE_RESOLVER to fetch per-field RLS values.</li> <li>Only sets session vars for fields in RLS_FIELDS.</li> </ul> <p>These variables are used in PostgreSQL RLS policies with current_setting().</p> <p></p>"},{"location":"api/#django_rlsexceptions","title":"django_rls.exceptions","text":""},{"location":"api/#django_rlsadmin","title":"django_rls.admin","text":""},{"location":"api/#django_rlssettings_type","title":"django_rls.settings_type","text":""},{"location":"api/#djangorlssettings-objects","title":"DjangoRLSSettings Objects","text":"<pre><code>@dataclass\nclass DjangoRLSSettings()\n</code></pre> <p>DjangoRLSSettings</p> <p>Configuration for enabling PostgreSQL Row-Level Security (RLS) across selected Django models, with enforcement scoped by model fields and session variables.</p> <p>This includes dynamic policy generation, session binding, and model auto-filling.</p> <p></p>"},{"location":"api/#rls_fields","title":"RLS_FIELDS","text":"<p>A list of field names to be set as PostgreSQL session variables. These fields are extracted from the user/context by REQUEST_RESOLVER and set as <code>rls.field_name</code> in the database session.</p> <p>Example:</p> <p>RLS_FIELDS = [\"tenant_id\", \"user_id\"]</p> <p></p>"},{"location":"api/#tenant_apps","title":"TENANT_APPS","text":"<p>List of app labels where all models should be treated as tenant-specific. When using <code>add_rls</code>, models in these apps will automatically default to using <code>tenant_id</code> for RLS if the field exists.</p> <p></p>"},{"location":"api/#request_resolver","title":"REQUEST_RESOLVER","text":"<p>A function that returns the current RLS context to set into PostgreSQL session variables.</p> <p>Example return:     {         \"user_id\": 1,         \"tenant_id\": 4,         \"public\":true,     }</p> <p>This value is used for: - Setting session variables like <code>SET rls.tenant_id = 123</code> - Auto-filling fields on models if AUTO_SET_FIELDS = True</p> <p>You can plug in a Django request-based or Strawberry GraphQL resolver here.</p> <p></p>"},{"location":"api/#bypass_check_resolver","title":"BYPASS_CHECK_RESOLVER","text":"<p>Optional function to determine if RLS should be bypassed entirely for a request or context.</p> <p>If this returns True, all fields in RLS_FIELDS will be set to RlsWildcard.ALL.</p> <p>Example use case:     - Allow superusers to bypass RLS enforcement     - Allow specific IPs or roles to see all data</p> <p></p>"},{"location":"api/#auto_set_fields","title":"AUTO_SET_FIELDS","text":"<p>If True, models in TENANT_APPS will have their RLS fields automatically set on creation/save based on the current session context (as resolved by <code>REQUEST_RESOLVER</code>).</p> <p>For example, if a model requires <code>tenant_id</code> and <code>user_id</code>, and the current session provides:</p> <p>Then calling <code>model.save()</code> will auto-fill these fields before validation (unless explicitly set). This helps prevent accidental leaks or incomplete data in a multi-tenant system.</p> <p></p>"},{"location":"api/#skip_models","title":"SKIP_MODELS","text":"<p>Optional list of model paths (e.g., <code>\"app.Model\"</code>) to explicitly exclude from AUTO_SET_FIELDS even if they are in TENANT_APPS.</p> <p>Example:</p> <p>SKIP_MODELS = [   \"core.AuditLog\",   \"sessions.Session\"   ]</p> <p></p>"},{"location":"api/#session_namespace_prefix","title":"SESSION_NAMESPACE_PREFIX","text":"<p>Prefix for PostgreSQL session variables used in <code>current_setting()</code>.</p> <p>Changing this will break existing RLS policies unless manually updated.</p> <p></p>"},{"location":"api/#use_db_migration_user","title":"USE_DB_MIGRATION_USER","text":"<p>If True, migrations (and potentially startup checks) that apply RLS policies will explicitly use the <code>MIGRATION_USER</code> and <code>MIGRATION_PASSWORD</code> credentials.</p> <p>This ensures that runtime roles (used by the app) are properly enforced by RLS as they are not the owner of the RLS policy.</p> <p></p>"},{"location":"api/#migration_user","title":"MIGRATION_USER","text":"<p>Username of the dedicated RLS-safe migration user.</p> <p>This user must: - Have sufficient privileges to create policies - Be separate from the app's runtime role</p> <p></p>"},{"location":"api/#migration_password","title":"MIGRATION_PASSWORD","text":"<p>Password for the MIGRATION_USER.</p> <p></p>"},{"location":"api/#django_rlsmigration_hook","title":"django_rls.migration_hook","text":""},{"location":"api/#django_rlsmigrations","title":"django_rls.migrations","text":""},{"location":"api/#rundynamicsql-objects","title":"RunDynamicSQL Objects","text":"<pre><code>class RunDynamicSQL(Operation)\n</code></pre> <p>A custom migration operation that generates SQL at runtime.</p> <p>This operation is used to create and drop RLS policies dynamically. The SQL is generated by the provided functions at migration time, allowing for dynamic table and policy name resolution.</p> <p>Arguments:</p> <ul> <li><code>create_func</code> - A callable that takes a schema_editor and returns SQL string   to create the RLS policy.</li> <li><code>drop_func</code> - A callable that takes a schema_editor and returns SQL string   to drop the RLS policy.</li> </ul> <p></p>"},{"location":"api/#django_rlsmanagementcommandsadd_rls","title":"django_rls.management.commands.add_rls","text":""},{"location":"api/#django_rlsmanagementcommandsmakemigrations","title":"django_rls.management.commands.makemigrations","text":""},{"location":"api/#django_rlsmanagementcommands","title":"django_rls.management.commands","text":""},{"location":"api/#django_rlsmanagement","title":"django_rls.management","text":""},{"location":"configuration/resolvers/","title":"Resolvers","text":"<p>Resolvers are functions that extract RLS context values from requests or GraphQL info objects.</p>"},{"location":"configuration/resolvers/#built-in-resolvers","title":"Built-in Resolvers","text":"<p>django-rls provides several built-in resolvers. For complete API documentation, see the API Reference (search for <code>resolvers</code>).</p>"},{"location":"configuration/resolvers/#using-built-in-resolvers","title":"Using Built-in Resolvers","text":"<pre><code>from django_rls.resolvers import (\n    default_request_user_resolver,\n    default_rls_bypass_check,\n    strawberry_context_user_resolver,\n    strawberry_rls_bypass_check,\n)\n\n# For Django requests\nDJANGO_RLS = DjangoRLSSettings(\n    REQUEST_RESOLVER=default_request_user_resolver,\n    BYPASS_CHECK_RESOLVER=default_rls_bypass_check,\n)\n\n# For Strawberry GraphQL\nDJANGO_RLS = DjangoRLSSettings(\n    REQUEST_RESOLVER=strawberry_context_user_resolver,\n    BYPASS_CHECK_RESOLVER=strawberry_rls_bypass_check,\n)\n</code></pre>"},{"location":"configuration/resolvers/#custom-resolvers","title":"Custom Resolvers","text":"<p>You can create custom resolvers for your specific needs.</p>"},{"location":"configuration/resolvers/#custom-request-resolver","title":"Custom Request Resolver","text":"<pre><code>from typing import Any, Dict\nfrom django_rls.constants import RLSValue, RlsWildcard\n\ndef my_custom_resolver(request: Any) -&gt; Dict[str, RLSValue]:\n    \"\"\"\n    Custom resolver that extracts RLS values from request.\n\n    Returns a dictionary mapping field names to their values.\n    \"\"\"\n    user = getattr(request, \"user\", None)\n    if not user or not getattr(user, \"is_authenticated\", False):\n        return {}\n\n    return {\n        \"tenant_id\": user.tenant.id if hasattr(user, \"tenant\") else RlsWildcard.NONE,\n        \"user_id\": user.id,\n        \"organization_id\": user.organization.id if hasattr(user, \"organization\") else None,\n    }\n\nDJANGO_RLS = DjangoRLSSettings(\n    REQUEST_RESOLVER=my_custom_resolver,\n)\n</code></pre>"},{"location":"configuration/resolvers/#custom-bypass-check","title":"Custom Bypass Check","text":"<pre><code>from typing import Any\n\ndef my_bypass_check(request: Any) -&gt; bool:\n    \"\"\"\n    Custom bypass check.\n\n    Returns True if RLS should be bypassed for this request.\n    \"\"\"\n    user = getattr(request, \"user\", None)\n    if not user:\n        return False\n\n    # Bypass for superusers\n    if getattr(user, \"is_superuser\", False):\n        return True\n\n    # Bypass for specific roles\n    if hasattr(user, \"role\") and user.role == \"admin\":\n        return True\n\n    # Bypass for specific IPs\n    ip = request.META.get(\"REMOTE_ADDR\")\n    if ip in [\"127.0.0.1\", \"192.168.1.100\"]:\n        return True\n\n    return False\n\nDJANGO_RLS = DjangoRLSSettings(\n    BYPASS_CHECK_RESOLVER=my_bypass_check,\n)\n</code></pre>"},{"location":"configuration/resolvers/#rls-values","title":"RLS Values","text":"<p>Resolvers can return:</p> <ul> <li>Integer/string values: Direct values like <code>123</code> or <code>\"tenant-abc\"</code></li> <li>RlsWildcard.NONE: Indicates no value (treated as <code>None</code> in database)</li> <li>RlsWildcard.ALL: Special wildcard that bypasses RLS for that field (only used by bypass check)</li> </ul> <pre><code>from django_rls.constants import RlsWildcard\n\n{\n    \"tenant_id\": 123,  # Specific tenant\n    \"user_id\": RlsWildcard.NONE,  # No user restriction\n    \"organization_id\": RlsWildcard.ALL,  # Bypass (only if bypass check returns True)\n}\n</code></pre>"},{"location":"configuration/resolvers/#next-steps","title":"Next Steps","text":"<ul> <li>Custom Resolvers - Advanced resolver patterns</li> <li>Bypass Checks - Advanced bypass patterns</li> </ul>"},{"location":"configuration/settings/","title":"Configuration","text":"<p>The <code>DJANGO_RLS</code> setting controls how django-rls behaves in your application.</p>"},{"location":"configuration/settings/#basic-configuration","title":"Basic Configuration","text":"<pre><code>from django_rls.settings_type import DjangoRLSSettings\nfrom django_rls.resolvers import default_request_user_resolver, default_rls_bypass_check\n\nDJANGO_RLS = DjangoRLSSettings(\n    RLS_FIELDS=[\"tenant_id\", \"user_id\"],\n    TENANT_APPS=[\"myapp\"],\n    REQUEST_RESOLVER=default_request_user_resolver,\n    BYPASS_CHECK_RESOLVER=default_rls_bypass_check,\n    AUTO_SET_FIELDS=True,\n)\n</code></pre>"},{"location":"configuration/settings/#complete-settings-reference","title":"Complete Settings Reference","text":"<p>For complete documentation of all settings fields, types, and defaults, see the API Reference (search for <code>DjangoRLSSettings</code>).</p>"},{"location":"configuration/settings/#common-configuration-examples","title":"Common Configuration Examples","text":""},{"location":"configuration/settings/#multi-tenant-setup","title":"Multi-Tenant Setup","text":"<pre><code>DJANGO_RLS = DjangoRLSSettings(\n    RLS_FIELDS=[\"tenant_id\", \"user_id\"],\n    TENANT_APPS=[\"myapp\", \"otherapp\"],\n    AUTO_SET_FIELDS=True,\n)\n</code></pre>"},{"location":"configuration/settings/#custom-resolver","title":"Custom Resolver","text":"<pre><code>def my_custom_resolver(request):\n    return {\n        \"tenant_id\": request.user.tenant.id,\n        \"user_id\": request.user.id,\n    }\n\nDJANGO_RLS = DjangoRLSSettings(\n    RLS_FIELDS=[\"tenant_id\", \"user_id\"],\n    REQUEST_RESOLVER=my_custom_resolver,\n)\n</code></pre>"},{"location":"configuration/settings/#custom-bypass-check","title":"Custom Bypass Check","text":"<pre><code>def my_bypass_check(request):\n    # Allow superusers and specific IPs\n    if request.user.is_superuser:\n        return True\n    if request.META.get('REMOTE_ADDR') == '192.168.1.100':\n        return True\n    return False\n\nDJANGO_RLS = DjangoRLSSettings(\n    BYPASS_CHECK_RESOLVER=my_bypass_check,\n)\n</code></pre>"},{"location":"configuration/settings/#migration-user-setup","title":"Migration User Setup","text":"<pre><code>DJANGO_RLS = DjangoRLSSettings(\n    USE_DB_MIGRATION_USER=True,\n    MIGRATION_USER=\"migration_user\",\n    MIGRATION_PASSWORD=\"secure_password\",\n)\n</code></pre>"},{"location":"configuration/settings/#next-steps","title":"Next Steps","text":"<ul> <li>API Reference - Complete settings documentation</li> <li>Resolvers - Learn about built-in and custom resolvers</li> <li>Usage Examples - See how to use these settings</li> </ul>"},{"location":"getting-started/installation/","title":"Installation","text":""},{"location":"getting-started/installation/#requirements","title":"Requirements","text":"<ul> <li>Django &gt;= 4.2, &lt; 5.4</li> <li>PostgreSQL (RLS is PostgreSQL-only feature)</li> <li>Python &gt;= 3.10, &lt; 3.14</li> </ul>"},{"location":"getting-started/installation/#install-django-rls","title":"Install django-rls","text":"<p>Install django-rls using pip:</p> <pre><code>pip install django-rls\n</code></pre> <p>Or using uv:</p> <pre><code>uv add django-rls\n</code></pre>"},{"location":"getting-started/installation/#database-setup","title":"Database Setup","text":"<p>django-rls requires PostgreSQL as it relies on PostgreSQL's Row-Level Security features. Make sure your Django project is configured to use PostgreSQL:</p> <pre><code># settings.py\nDATABASES = {\n    'default': {\n        'ENGINE': 'django.db.backends.postgresql',\n        'NAME': 'your_database',\n        'USER': 'your_user',\n        'PASSWORD': 'your_password',\n        'HOST': 'localhost',\n        'PORT': '5432',\n    }\n}\n</code></pre>"},{"location":"getting-started/installation/#enable-rls-in-postgresql","title":"Enable RLS in PostgreSQL","text":"<p>Row-Level Security must be enabled on the tables you want to protect. This is typically done when creating RLS policies, but you can also enable it manually:</p> <pre><code>ALTER TABLE your_table ENABLE ROW LEVEL SECURITY;\n</code></pre> <p>The <code>add_rls</code> management command (see Adding RLS) will handle this automatically.</p>"},{"location":"getting-started/installation/#next-steps","title":"Next Steps","text":"<ul> <li>Quick Start Guide - Get up and running quickly</li> <li>Configuration - Configure django-rls for your needs</li> </ul>"},{"location":"getting-started/quick-start/","title":"Quick Start","text":"<p>This guide will help you get django-rls up and running in your Django project.</p>"},{"location":"getting-started/quick-start/#step-1-add-middleware","title":"Step 1: Add Middleware","text":"<p>Add <code>RLSMiddleware</code> to your <code>MIDDLEWARE</code> setting:</p> <pre><code># settings.py\nMIDDLEWARE = [\n    'django.middleware.security.SecurityMiddleware',\n    'django.contrib.sessions.middleware.SessionMiddleware',\n    'django.middleware.common.CommonMiddleware',\n    'django.middleware.csrf.CsrfViewMiddleware',\n    'django.contrib.auth.middleware.AuthenticationMiddleware',\n    'django.contrib.messages.middleware.MessageMiddleware',\n    'django.middleware.clickjacking.XFrameOptionsMiddleware',\n    # Add RLS middleware after AuthenticationMiddleware\n    'django_rls.middleware.RLSMiddleware',\n]\n</code></pre>"},{"location":"getting-started/quick-start/#step-2-configure-settings","title":"Step 2: Configure Settings","text":"<p>Add <code>DJANGO_RLS</code> configuration to your settings:</p> <pre><code># settings.py\nfrom django_rls.settings_type import DjangoRLSSettings\nfrom django_rls.resolvers import default_request_user_resolver, default_rls_bypass_check\n\nDJANGO_RLS = DjangoRLSSettings(\n    RLS_FIELDS=[\"tenant_id\", \"user_id\"],\n    TENANT_APPS=[\"myapp\"],\n    REQUEST_RESOLVER=default_request_user_resolver,\n    BYPASS_CHECK_RESOLVER=default_rls_bypass_check,\n    AUTO_SET_FIELDS=True,\n)\n</code></pre>"},{"location":"getting-started/quick-start/#step-3-add-rls-fields-to-models","title":"Step 3: Add RLS Fields to Models","text":"<p>Add the RLS fields to your models:</p> <pre><code># myapp/models.py\nfrom django.db import models\n\nclass MyModel(models.Model):\n    tenant_id = models.IntegerField()\n    user_id = models.IntegerField()\n    name = models.CharField(max_length=100)\n    # ... other fields\n</code></pre>"},{"location":"getting-started/quick-start/#step-4-create-rls-policies","title":"Step 4: Create RLS Policies","text":"<p>Use the management command to add RLS policies:</p> <pre><code>python manage.py add_rls myapp.MyModel\n</code></pre> <p>This will: - Enable RLS on the table - Create RLS policies based on your configuration - Set up session variable checks</p>"},{"location":"getting-started/quick-start/#step-5-create-postgresql-policies","title":"Step 5: Create PostgreSQL Policies","text":"<p>The <code>add_rls</code> command will generate SQL for you. You'll need to create the actual policies in PostgreSQL. See Adding RLS for more details.</p>"},{"location":"getting-started/quick-start/#what-happens-next","title":"What Happens Next?","text":"<p>Once configured:</p> <ol> <li>On each request: The middleware extracts RLS values from the user/context</li> <li>Session variables are set: PostgreSQL session variables are set (e.g., <code>rls.tenant_id</code>, <code>rls.user_id</code>)</li> <li>RLS policies enforce access: PostgreSQL RLS policies check these session variables</li> <li>Auto-fill fields: If <code>AUTO_SET_FIELDS=True</code>, fields are automatically set on model save</li> </ol>"},{"location":"getting-started/quick-start/#example-accessing-data","title":"Example: Accessing Data","text":"<pre><code># views.py\nfrom django.shortcuts import render\nfrom myapp.models import MyModel\n\ndef my_view(request):\n    # RLS middleware has already set session variables\n    # PostgreSQL will automatically filter based on RLS policies\n    items = MyModel.objects.all()  # Only returns items matching RLS context\n    return render(request, 'template.html', {'items': items})\n</code></pre>"},{"location":"getting-started/quick-start/#next-steps","title":"Next Steps","text":"<ul> <li>Configuration Guide - Learn about all configuration options</li> <li>Adding RLS - Detailed guide on adding RLS to models</li> <li>Custom Resolvers - Create custom resolvers for your needs</li> </ul>"},{"location":"usage/adding-rls/","title":"Adding RLS","text":"<p>The <code>add_rls</code> management command helps you add Row-Level Security to your Django models.</p> <p>For complete API documentation, see the API Reference (search for <code>add_rls</code>).</p>"},{"location":"usage/adding-rls/#basic-usage","title":"Basic Usage","text":"<pre><code>python manage.py add_rls myapp.MyModel\n</code></pre> <p>This will: - Enable RLS on the table - Generate SQL for creating RLS policies - Show you the SQL to run in PostgreSQL</p>"},{"location":"usage/adding-rls/#interactive-mode","title":"Interactive Mode","text":"<p>Run without arguments for interactive mode:</p> <pre><code>python manage.py add_rls\n</code></pre> <p>The command will prompt you to: 1. Select the app 2. Select the model 3. Choose which RLS fields to use 4. Configure policy options</p>"},{"location":"usage/adding-rls/#field-selection","title":"Field Selection","text":"<p>The command will automatically detect RLS fields from your <code>RLS_FIELDS</code> setting and suggest fields that exist on the model.</p> <p>For models in <code>TENANT_APPS</code>, <code>tenant_id</code> will be suggested by default if the field exists.</p>"},{"location":"usage/adding-rls/#generated-sql","title":"Generated SQL","text":"<p>The command generates SQL that you need to run in PostgreSQL. Example:</p> <pre><code>-- Enable RLS\nALTER TABLE myapp_mymodel ENABLE ROW LEVEL SECURITY;\n\n-- Create policy\nCREATE POLICY tenant_isolation ON myapp_mymodel\n    FOR ALL\n    USING (tenant_id = current_setting('rls.tenant_id')::integer);\n</code></pre>"},{"location":"usage/adding-rls/#policy-types","title":"Policy Types","text":"<p>The command can generate different types of policies:</p> <ul> <li>SELECT: For read operations</li> <li>INSERT: For create operations</li> <li>UPDATE: For update operations</li> <li>DELETE: For delete operations</li> <li>ALL: For all operations (default)</li> </ul>"},{"location":"usage/adding-rls/#multiple-fields","title":"Multiple Fields","text":"<p>You can use multiple RLS fields:</p> <pre><code>python manage.py add_rls myapp.MyModel --fields tenant_id user_id\n</code></pre> <p>This will create policies that check both fields:</p> <pre><code>CREATE POLICY tenant_user_isolation ON myapp_mymodel\n    FOR ALL\n    USING (\n        tenant_id = current_setting('rls.tenant_id')::integer\n        AND user_id = current_setting('rls.user_id')::integer\n    );\n</code></pre>"},{"location":"usage/adding-rls/#next-steps","title":"Next Steps","text":"<ul> <li>Migrations - How to handle migrations with RLS</li> <li>Configuration - Configure RLS settings</li> </ul>"},{"location":"usage/middleware/","title":"Middleware","text":"<p>The <code>RLSMiddleware</code> is responsible for setting PostgreSQL session variables based on the current request context.</p> <p>For complete API documentation, see the API Reference (search for <code>RLSMiddleware</code>).</p>"},{"location":"usage/middleware/#how-it-works","title":"How It Works","text":"<ol> <li>Request Processing: On each request, the middleware runs <code>REQUEST_RESOLVER</code> to get RLS context values</li> <li>Bypass Check: If <code>BYPASS_CHECK_RESOLVER</code> returns <code>True</code>, all fields are set to <code>RlsWildcard.ALL</code></li> <li>Session Variables: PostgreSQL session variables are set (e.g., <code>SET rls.tenant_id = 123</code>)</li> <li>RLS Enforcement: PostgreSQL RLS policies use <code>current_setting()</code> to read these variables</li> </ol>"},{"location":"usage/middleware/#setup","title":"Setup","text":"<p>Add the middleware to your <code>MIDDLEWARE</code> setting:</p> <pre><code>MIDDLEWARE = [\n    'django.middleware.security.SecurityMiddleware',\n    'django.contrib.sessions.middleware.SessionMiddleware',\n    'django.middleware.common.CommonMiddleware',\n    'django.middleware.csrf.CsrfViewMiddleware',\n    'django.contrib.auth.middleware.AuthenticationMiddleware',\n    'django.contrib.messages.middleware.MessageMiddleware',\n    # Add RLS middleware after AuthenticationMiddleware\n    'django_rls.middleware.RLSMiddleware',\n]\n</code></pre> <p>Important: Place <code>RLSMiddleware</code> after <code>AuthenticationMiddleware</code> so that <code>request.user</code> is available.</p>"},{"location":"usage/middleware/#session-variables","title":"Session Variables","text":"<p>The middleware sets PostgreSQL session variables in the format:</p> <pre><code>{rls.SESSION_NAMESPACE_PREFIX}.{field_name} = {value}\n</code></pre> <p>For example, with default settings: - <code>rls.tenant_id = 123</code> - <code>rls.user_id = 456</code></p> <p>These variables are available in PostgreSQL RLS policies:</p> <pre><code>CREATE POLICY tenant_isolation ON myapp_mymodel\n    FOR ALL\n    USING (tenant_id = current_setting('rls.tenant_id')::integer);\n</code></pre>"},{"location":"usage/middleware/#bypass-behavior","title":"Bypass Behavior","text":"<p>When <code>BYPASS_CHECK_RESOLVER</code> returns <code>True</code>, all RLS fields are set to a special wildcard value that bypasses RLS checks. This is useful for:</p> <ul> <li>Superuser access</li> <li>Admin interfaces</li> <li>System operations</li> <li>Specific IP addresses</li> </ul>"},{"location":"usage/middleware/#database-vendor-check","title":"Database Vendor Check","text":"<p>The middleware automatically skips processing if the database vendor is not PostgreSQL (since RLS is PostgreSQL-only). This allows your application to work with other databases during development, though RLS won't be enforced.</p>"},{"location":"usage/middleware/#example","title":"Example","text":"<pre><code># settings.py\nDJANGO_RLS = DjangoRLSSettings(\n    RLS_FIELDS=[\"tenant_id\", \"user_id\"],\n    REQUEST_RESOLVER=default_request_user_resolver,\n)\n\n# On each request:\n# 1. REQUEST_RESOLVER extracts: {\"tenant_id\": 123, \"user_id\": 456}\n# 2. Middleware executes:\n#    SET rls.tenant_id = 123;\n#    SET rls.user_id = 456;\n# 3. PostgreSQL RLS policies check these values\n# 4. Only matching rows are returned\n</code></pre>"},{"location":"usage/middleware/#next-steps","title":"Next Steps","text":"<ul> <li>Adding RLS - How to add RLS policies to models</li> <li>Migrations - Handling migrations with RLS</li> </ul>"},{"location":"usage/migrations/","title":"Migrations","text":"<p>Handling migrations with Row-Level Security requires special consideration.</p> <p>For API documentation on migration-related classes, see the API Reference (search for <code>migrations</code>).</p>"},{"location":"usage/migrations/#migration-user","title":"Migration User","text":"<p>When using RLS, it's important to have a dedicated migration user that can bypass or work around RLS policies during migrations.</p>"},{"location":"usage/migrations/#why","title":"Why?","text":"<ul> <li>Migrations need to modify tables and policies</li> <li>The app's runtime user should be subject to RLS</li> <li>A separate migration user ensures migrations can run safely</li> </ul>"},{"location":"usage/migrations/#setup","title":"Setup","text":"<pre><code># settings.py\nDJANGO_RLS = DjangoRLSSettings(\n    USE_DB_MIGRATION_USER=True,\n    MIGRATION_USER=\"migration_user\",\n    MIGRATION_PASSWORD=\"secure_password\",\n)\n</code></pre>"},{"location":"usage/migrations/#creating-the-migration-user","title":"Creating the Migration User","text":"<p>In PostgreSQL:</p> <pre><code>CREATE USER migration_user WITH PASSWORD 'secure_password';\nGRANT ALL PRIVILEGES ON DATABASE your_database TO migration_user;\nGRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO migration_user;\nGRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO migration_user;\n</code></pre>"},{"location":"usage/migrations/#migration-hooks","title":"Migration Hooks","text":"<p>django-rls includes migration hooks that automatically handle RLS during migrations. The <code>makemigrations</code> command hook ensures RLS policies are properly managed.</p>"},{"location":"usage/migrations/#running-migrations","title":"Running Migrations","text":"<p>With <code>USE_DB_MIGRATION_USER=True</code>, migrations will use the migration user credentials:</p> <pre><code>python manage.py migrate\n</code></pre>"},{"location":"usage/migrations/#manual-migration-steps","title":"Manual Migration Steps","text":"<p>If you need to manually handle RLS during migrations:</p> <ol> <li> <p>Temporarily disable RLS (if needed):    <pre><code>ALTER TABLE myapp_mymodel DISABLE ROW LEVEL SECURITY;\n</code></pre></p> </li> <li> <p>Run the migration:    <pre><code>python manage.py migrate\n</code></pre></p> </li> <li> <p>Re-enable RLS:    <pre><code>ALTER TABLE myapp_mymodel ENABLE ROW LEVEL SECURITY;\n</code></pre></p> </li> <li> <p>Update policies if schema changed:    <pre><code>python manage.py add_rls myapp.MyModel\n</code></pre></p> </li> </ol>"},{"location":"usage/migrations/#best-practices","title":"Best Practices","text":"<ol> <li>Always use a migration user for production</li> <li>Test migrations in a development environment first</li> <li>Review generated SQL before applying policies</li> <li>Backup your database before running migrations</li> <li>Document policy changes in migration files</li> </ol>"},{"location":"usage/migrations/#next-steps","title":"Next Steps","text":"<ul> <li>Adding RLS - How to add RLS to models</li> <li>Configuration - Migration user configuration</li> </ul>"}]}